#!/bin/bash
set -e

LOGFILE="/var/log/nvhpc_env_config.log"
exec >> "$LOGFILE" 2>&1

echo "===== Configuring NVIDIA HPC SDK environment ====="

# Cloud-init safe defaults
export HOME=/root

NVCOMPILERS="/opt/nvidia/nvhpc"
NVARCH="$(uname -s)_$(uname -m)"
sys_arch="$(uname -m)"
case "${sys_arch}" in
    x86_64|amd64) arch="x86_64" ;;
    aarch64|arm64) arch="aarch64" ;;
esac

# Select package name based on detected architecture (rendered from slurm_config vars)
case "${arch}" in
    x86_64)  NVHPC_PKG_NAME="{{ nvhpc_pkg_name_x86_64 }}" ;;
    aarch64) NVHPC_PKG_NAME="{{ nvhpc_pkg_name_aarch64 }}" ;;
esac

# Derive version from package name
NVHPC_VERSION=$(echo "$NVHPC_PKG_NAME" | sed 's/nvhpc_\([0-9]*_[0-9]*\)_Linux_.*/\1/' | cut -d'_' -f2 | sed 's/\(..\)\(..\)/\1.\2/')


NVHPC_BASE="$NVCOMPILERS/$NVARCH/$NVHPC_VERSION"
PROFILE_FILE="/etc/profile.d/nvhpc.sh"

if [ ! -d "$NVHPC_BASE/compilers/bin" ]; then
    echo "[ERROR] NVHPC compilers not found at $NVHPC_BASE"
    exit 1
fi

echo "[INFO] NVHPC detected at $NVHPC_BASE"
echo "[INFO] Writing persistent environment to $PROFILE_FILE"

cat << EOF > "$PROFILE_FILE"
# NVIDIA HPC SDK environment
export NVCOMPILERS=$NVCOMPILERS
export NVARCH=$NVARCH
export NVHPC_VERSION=$NVHPC_VERSION

export PATH=\$NVCOMPILERS/\$NVARCH/\$NVHPC_VERSION/compilers/bin:\$PATH
export MANPATH=\${MANPATH:-}:\$NVCOMPILERS/\$NVARCH/\$NVHPC_VERSION/compilers/man

# MPI (optional but recommended)
export PATH=\$NVCOMPILERS/\$NVARCH/\$NVHPC_VERSION/comm_libs/mpi/bin:\$PATH
export MANPATH=\${MANPATH:-}:\$NVCOMPILERS/\$NVARCH/\$NVHPC_VERSION/comm_libs/mpi/man

# Modules support (optional)
export MODULEPATH=\$NVCOMPILERS/modulefiles:\${MODULEPATH:-}
EOF

chmod 644 "$PROFILE_FILE"

# Source profile for current shell and all future non-login shells
if [ -f "$PROFILE_FILE" ]; then
    echo "[INFO] Sourcing NVHPC profile for current shell"
    source "$PROFILE_FILE"
    grep -q "nvhpc.sh" /etc/bashrc || echo "source $PROFILE_FILE" >> /etc/bashrc
fi


if ! grep -q "{{ cloud_init_nfs_path }}/hpc_tools/nvidia_sdk/nvhpc" /etc/fstab; then
    echo "[ERROR] NVHPC NFS path not found in /etc/fstab"
    exit 1
fi

echo "[INFO] NVHPC NFS entry found in /etc/fstab"

echo "===== NVHPC environment configuration completed successfully ====="
