# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
- name: Slurm dict ops
  ansible.builtin.set_fact:
    apply_config: "{{ __default_config }}"
  no_log: true

- name: Remove keys from conf_files if they have string values in configs_input (when skip_merge is true)
  ansible.builtin.set_fact:
    conf_files: "{{ conf_files | difference(configs_input | dict2items | selectattr('value', 'string') | map(attribute='key') | list) }}"
  when:
    - skip_merge | default(false)
    - configs_input is defined

- name: Build slurm.conf
  ansible.builtin.include_tasks: build_slurm_conf.yml
  when: "'slurm' in conf_files"

- name: Slurm dbd opts
  ansible.builtin.set_fact:
    apply_config: "{{ apply_config | default({})
     | combine({'slurmdbd': (apply_config['slurmdbd']
     | combine({'DbdHost': ctld_list[0], 'StorageHost': ctld_list[0]}))}) }}"
  when: ctld_list
  no_log: true

- name: Check .conf files existence
  ansible.builtin.stat:
    path: "{{ slurm_config_path }}/{{ item.0 }}/etc/slurm/{{ item.1 }}.conf"
  when: ctld_list
  loop: "{{ ctld_list | product(conf_files | default([])) }}"
  register: ctld_conf_files

- name: Parse configs_input files from localhost (if they are paths)
  slurm_conf:
    op: parse
    conf_name: "{{ item.key }}"
    path: "{{ item.value }}"
  delegate_to: localhost
  loop: "{{ configs_input | default({}) | dict2items }}"
  register: parsed_configs_input_results
  no_log: true
  when:
    - configs_input is defined
    - configs_input
    - item.value is string
    - item.key in conf_files

- name: Build parsed_configs_input dictionary from parsed files
  ansible.builtin.set_fact:
    parsed_configs_input: "{{ parsed_configs_input | default({}) | combine({item.item.key: item.conf_dict}) }}"
  loop: "{{ parsed_configs_input_results.results }}"
  no_log: true
  when:
    - parsed_configs_input_results is defined
    - not item.skipped | default(false)

- name: Add configs_input dicts that are already parsed
  ansible.builtin.set_fact:
    parsed_configs_input: "{{ parsed_configs_input | default({}) | combine({item.key: item.value}) }}"
  loop: "{{ configs_input | default({}) | dict2items }}"
  no_log: true
  when:
    - configs_input is defined
    - configs_input
    - item.value is mapping

- name: Create lists for conf_merge
  ansible.builtin.set_fact:
    conf_merge_dict: "{{
        conf_merge_dict | default({})
        | combine({
            existing_conf_set.item.1: (
              [apply_config[existing_conf_set.item.1]]
              + ([existing_conf_set.stat.path] if existing_conf_set.stat.exists else [])
              + ([parsed_configs_input.get(existing_conf_set.item.1)]
               if parsed_configs_input is defined and parsed_configs_input.get(existing_conf_set.item.1) else [])
            )
          })
      }}"
  loop: "{{ ctld_conf_files.results }}"
  loop_control:
    loop_var: existing_conf_set
  register: prepared_conf_lists
  no_log: true

# All the updates to the confs follow after this point before merge
- name: Prepend ClusterName and SlurmctldHost to slurm conf sources
  ansible.builtin.set_fact: # TODO: Change order if needed
    conf_merge_dict: "{{ conf_merge_dict
     | combine({'slurm': [{'ClusterName': cluster_name, 'AccountingStorageHost': dbd_list[0], 'SlurmctldHost': ctld_list}] + conf_merge_dict['slurm']}) }}"
  when: "'slurm' in conf_merge_dict"
  no_log: true

- name: Slurm dbd - DbdHost and StorageHost
  ansible.builtin.set_fact:
    conf_merge_dict: "{{ conf_merge_dict
     | combine({'slurmdbd': [{'DbdHost': ctld_list[0], 'StorageHost': ctld_list[0]}] + conf_merge_dict['slurmdbd']}) }}"
  when: "'slurmdbd' in conf_merge_dict"
  no_log: true

- name: Merge the confs
  slurm_conf:
    op: merge
    conf_sources: "{{ item.value }}"
    conf_name: "{{ item.key }}"
  loop: "{{ conf_merge_dict | dict2items }}"
  register: merged_conf
  no_log: true

- name: Update slurm_conf_dict with merged configuration for cloud_init read. # TODO: Remove cloud init dependency
  ansible.builtin.set_fact:
    slurm_conf_dict: "{{ (merged_conf.results | selectattr('item.key', 'equalto', 'slurm') | first).conf_dict }}"
  when: "'slurm' in conf_merge_dict"

- name: Extract effective path parameters from merged configs
  ansible.builtin.include_tasks: extract_path_overrides.yml

- name: Validate path parameters are absolute
  ansible.builtin.include_tasks: validate_path_overrides.yml

- name: Get nodes from normal partition and compare with cmpt_list
  ansible.builtin.set_fact:
    normal_partition: "{{ slurm_conf_dict.PartitionName | default([]) | selectattr('PartitionName', 'equalto', slurm_partition_name) | first | default({}) }}"
  when: "'slurm' in conf_merge_dict"

- name: Parse normal partition nodes and compare
  ansible.builtin.set_fact:
    normal_partition_nodes: "{{ (normal_partition.Nodes | default('ALL')).split(',') | map('trim') | reject('equalto', 'ALL') | list }}"
    nodes_in_normal_not_in_cmpt: "{{ (normal_partition.Nodes | default('ALL')).split(',')
     | map('trim') | reject('equalto', 'ALL') | list | difference(cmpt_list) }}"
  when:
    - "'slurm' in conf_merge_dict"
    - normal_partition is defined
    - normal_partition | length > 0

- name: Remove nodes
  ansible.builtin.include_tasks: remove_node.yml
  when:
    - "'slurm' in conf_merge_dict"
    - nodes_in_normal_not_in_cmpt is defined
    - nodes_in_normal_not_in_cmpt | length > 0

- name: Create directories from conf values (NFS server-side always uses defaults)
  ansible.builtin.include_tasks: exist_dir.yml
  loop:
    - "{{ ctld_list
     | product(['/var/spool/slurmctld',
      '/var/log/slurm',
      '/var/run']) }}"
    - "{{ (cmpt_list + login_list + compiler_login_list)
     | product(['/var/spool/slurmd',
      '/var/log/slurm',
      '/var/run']) }}"
  loop_control:
    loop_var: product

- name: Generate slurmd opts for Configless # TODO: Move to $SLURMD_OPTIONS /etc/default/slurmd
  ansible.builtin.set_fact:
    conf_server: "--conf-server {{ ctld_list | map('regex_replace', '$', ':' ~ (slurm_conf_dict.get('SlurmctldPort', '6817') | string)) | join(',') }}"
  when: slurm_conf_dict is defined

- name: Write merged .conf
  ansible.builtin.copy:
    content: "{{ item.ini_lines | join('\n') }}\n"
    dest: "{{ slurm_config_path }}/{{ ctld_list[0] }}/etc/slurm/{{ item.item.key }}.conf"
    mode: "{{ slurm_dbd_mode if item.item.key == 'slurmdbd' else slurm_mode }}"
    owner: "{{ slurm_user }}"
    group: "{{ slurm_user_group }}"
    remote_src: "{{ copy_from_oim }}"
  loop: "{{ merged_conf.results }}"
  register: ctld_conf_files
  no_log: true
  when:
    - item.ini_lines

- name: Add extra confs which are not handled
  ansible.builtin.include_tasks: handle_extra_confs.yml
  when:
    - configs_input is defined
    - configs_input.keys() | difference(conf_files) | length > 0
  loop: "{{ configs_input.keys() | difference(conf_files) }}"
  loop_control:
    loop_var: extra_conf

- name: Check if cluster running
  ansible.builtin.include_tasks: check_ctld_running.yml
  when:
    - ctld_list
    - ctld_conf_files is changed
  loop: "{{ ctld_list }}"
  loop_control:
    loop_var: ctld
