# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---

- name: Check if backup omnia_config_credentials.yml exists
  ansible.builtin.stat:
    path: "{{ backup_location }}/omnia_config_credentials.yml"
  register: backup_omnia_config_credentials_stat

- name: Check if backup omnia_config_credentials_key exists
  ansible.builtin.stat:
    path: "{{ backup_location }}/.omnia_config_credentials_key"
  register: backup_omnia_config_credentials_key_stat

- name: Add warning for missing omnia_config_credentials.yml to list
  ansible.builtin.set_fact:
    upgrade_warnings: >-
      {{ upgrade_warnings + [msg_omnia_config_credentials_missing] }}
  when:
    - not backup_omnia_config_credentials_stat.stat.exists
    - "'WARNING: omnia_config_credentials.yml not found in backup at' not in (upgrade_warnings | join(' '))"

- name: Check if backup file is encrypted
  ansible.builtin.command:
    cmd: cat "{{ backup_location }}/omnia_config_credentials.yml"
  register: backup_omnia_config_credentials_content
  changed_when: false
  failed_when: false
  no_log: true
  when: backup_omnia_config_credentials_stat.stat.exists

- name: Process omnia_config_credentials.yml when present in backup
  when: >-
    backup_omnia_config_credentials_key_stat.stat.exists and
    backup_omnia_config_credentials_content.stdout is defined and
    '$ANSIBLE_VAULT;' in backup_omnia_config_credentials_content.stdout
  block:
    - name: "Case 1: Key present and file encrypted - Process and update"
      block:
        - name: Copy encrypted omnia_config_credentials.yml from backup to temp location
          ansible.builtin.copy:
            src: "{{ backup_location }}/omnia_config_credentials.yml"
            dest: "{{ input_project_dir }}/omnia_config_credentials.yml.tmp"
            mode: '0600'
            remote_src: true

        - name: Copy omnia_config_credentials_key from backup
          ansible.builtin.copy:
            src: "{{ backup_location }}/.omnia_config_credentials_key"
            dest: "{{ input_project_dir }}/.omnia_config_credentials_key"
            mode: '0600'
            remote_src: true

        - name: Decrypt omnia_config_credentials.yml using the key
          ansible.builtin.shell:
            cmd: |
              ansible-vault decrypt "{{ input_project_dir }}/omnia_config_credentials.yml.tmp" \
                --vault-password-file "{{ input_project_dir }}/.omnia_config_credentials_key" \
                --output "{{ input_project_dir }}/omnia_config_credentials.yml.decrypted"
          args:
            executable: /bin/bash
          no_log: true
          register: vault_decrypt_result
          failed_when: vault_decrypt_result.rc != 0
          changed_when: false

        - name: Read decrypted content
          ansible.builtin.slurp:
            src: "{{ input_project_dir }}/omnia_config_credentials.yml.decrypted"
          register: decrypted_content
          no_log: true

        - name: Parse YAML content and extract credentials
          ansible.builtin.set_fact:
            credentials_dict: >-
              {{ decrypted_content.content | b64decode | from_yaml }}
          no_log: true

      rescue:
        - name: Fail with decryption error message
          ansible.builtin.fail:
            msg: "{{ msg_omnia_config_decrypt_error }}"

    - name: "Case 1.1: Apply template and encrypt"
      when: >
        backup_omnia_config_credentials_key_stat.stat.exists and
        backup_omnia_config_credentials_content.stdout is defined and
        '$ANSIBLE_VAULT;' in backup_omnia_config_credentials_content.stdout
      block:
        - name: Set template variables from credentials
          ansible.builtin.set_fact:
            provision_password: "{{ credentials_dict.provision_password | default('') }}"
            bmc_username: "{{ credentials_dict.bmc_username | default('') }}"
            bmc_password: "{{ credentials_dict.bmc_password | default('') }}"
            minio_s3_password: "{{ credentials_dict.minio_s3_password | default('') }}"
            pulp_password: "{{ credentials_dict.pulp_password | default('') }}"
            docker_username: "{{ credentials_dict.docker_username | default('') }}"
            docker_password: "{{ credentials_dict.docker_password | default('') }}"
            slurm_db_password: "{{ credentials_dict.slurm_db_password | default('') }}"
            openldap_db_username: "{{ credentials_dict.openldap_db_username | default('') }}"
            openldap_db_password: "{{ credentials_dict.openldap_db_password | default('') }}"
            mysqldb_user: "{{ credentials_dict.mysqldb_user | default('') }}"
            mysqldb_password: "{{ credentials_dict.mysqldb_password | default('') }}"
            mysqldb_root_password: "{{ credentials_dict.mysqldb_root_password | default('') }}"
            csi_username: "{{ credentials_dict.csi_username | default('') }}"
            csi_password: "{{ credentials_dict.csi_password | default('') }}"
            ldms_sampler_password: "{{ credentials_dict.ldms_sampler_password | default('') }}"
          no_log: true

        - name: Write updated content using template
          ansible.builtin.template:
            src: omnia_config_credentials.yml.j2
            dest: "{{ input_project_dir }}/omnia_config_credentials.yml.decrypted"
            mode: '0600'
          no_log: true

        - name: Encrypt updated file using the same key
          ansible.builtin.shell:
            cmd: |
              ansible-vault encrypt "{{ input_project_dir }}/omnia_config_credentials.yml.decrypted" \
                --vault-password-file "{{ input_project_dir }}/.omnia_config_credentials_key" \
                --output "{{ input_project_dir }}/omnia_config_credentials.yml"
          args:
            executable: /bin/bash
          no_log: true
          register: vault_encrypt_result
          failed_when: vault_encrypt_result.rc != 0
          changed_when: false

        - name: Clean up temporary files
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - "{{ input_project_dir }}/omnia_config_credentials.yml.tmp"
            - "{{ input_project_dir }}/omnia_config_credentials.yml.decrypted"

        - name: Display success message
          ansible.builtin.debug:
            msg: "{{ msg_omnia_config_credentials_success }}"

      rescue:
        - name: Fail with template/encryption error message
          ansible.builtin.fail:
            msg: "{{ msg_omnia_config_template_error }}\n{{ msg_omnia_config_encrypt_error }}"

    - name: "Case 2: Both key and file missing - Add info warning"
      when: >
        not backup_omnia_config_credentials_key_stat.stat.exists and
        (backup_omnia_config_credentials_content.stdout is not defined or
         '$ANSIBLE_VAULT;' not in backup_omnia_config_credentials_content.stdout) and
        "'INFO: Both omnia_config_credentials.yml and .omnia_config_credentials_key' not in (upgrade_warnings | join(' '))"
      ansible.builtin.set_fact:
        upgrade_warnings: >
          {{ upgrade_warnings + [msg_omnia_config_credentials_info_missing] }}

    - name: "Case 3: Error - Mismatched state"
      when: >
        (not backup_omnia_config_credentials_key_stat.stat.exists and
         backup_omnia_config_credentials_content.stdout is defined and
         '$ANSIBLE_VAULT;' in backup_omnia_config_credentials_content.stdout) or
        (backup_omnia_config_credentials_key_stat.stat.exists and
         backup_omnia_config_credentials_content.stdout is defined and
         '$ANSIBLE_VAULT;' not in backup_omnia_config_credentials_content.stdout)
      ansible.builtin.fail:
        msg: "{{ msg_omnia_config_credentials_error }}"
