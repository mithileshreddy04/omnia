# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---

- name: Check if backup user_registry_credential.yml exists
  ansible.builtin.stat:
    path: "{{ backup_location }}/user_registry_credential.yml"
  register: backup_user_registry_credential_stat

- name: Check if user_registry_credential.yml exists in current directory
  ansible.builtin.stat:
    path: "{{ input_project_dir }}/user_registry_credential.yml"
  register: user_registry_credential_stat

- name: Check if backup local_repo_credentials_key exists
  ansible.builtin.stat:
    path: "{{ backup_location }}/.local_repo_credentials_key"
  register: backup_local_repo_credentials_key_stat

- name: Add warning for missing user_registry_credential.yml to list
  ansible.builtin.set_fact:
    upgrade_warnings: >-
      {{ upgrade_warnings + [msg_user_registry_credential_missing] }}
  when:
    - not backup_user_registry_credential_stat.stat.exists
    - "'WARNING: user_registry_credential.yml not found in backup at' not in (upgrade_warnings | join(' '))"

- name: Check if backup file is encrypted
  ansible.builtin.command:
    cmd: cat "{{ backup_location }}/user_registry_credential.yml"
  register: backup_user_registry_content
  changed_when: false
  failed_when: false
  no_log: true
  when: backup_user_registry_credential_stat.stat.exists

- name: Process user_registry_credential.yml when present in backup
  when: >-
    backup_local_repo_credentials_key_stat.stat.exists and
    backup_user_registry_content.stdout is defined and
    '$ANSIBLE_VAULT;' in backup_user_registry_content.stdout
  block:

    - name: "Case 1: Key present and file encrypted - Copy both"
      when: >
        backup_local_repo_credentials_key_stat.stat.exists and
        backup_user_registry_content.stdout is defined and
        '$ANSIBLE_VAULT;' in backup_user_registry_content.stdout
      block:
        - name: Decrypt user_registry_credential.yml using the key
          ansible.builtin.shell:
            cmd: |
              ansible-vault decrypt "{{ input_project_dir }}/user_registry_credential.yml.tmp" \
                --vault-password-file "{{ input_project_dir }}/.local_repo_credentials_key" \
                --output "{{ input_project_dir }}/user_registry_credential.yml.decrypted"
          args:
            executable: /bin/bash
          no_log: true
          register: vault_decrypt_result
          failed_when: vault_decrypt_result.rc != 0
          changed_when: false

        - name: Copy encrypted user_registry_credential.yml from backup
          ansible.builtin.copy:
            src: "{{ backup_location }}/user_registry_credential.yml"
            dest: "{{ input_project_dir }}/user_registry_credential.yml"
            mode: '0600'
            remote_src: true

        - name: Copy local_repo_credentials_key from backup
          ansible.builtin.copy:
            src: "{{ backup_location }}/.local_repo_credentials_key"
            dest: "{{ input_project_dir }}/.local_repo_credentials_key"
            mode: '0600'
            remote_src: true

        - name: Display success message for encrypted file restoration
          ansible.builtin.debug:
            msg: |
              user_registry_credential.yml restored from backup.
              Backup: {{ backup_location }}/user_registry_credential.yml
              Target: {{ input_project_dir }}/user_registry_credential.yml
              Status: Encrypted (key file also restored)
      rescue:
        - name: Fail with decryption error message
          ansible.builtin.fail:
            msg: "{{ msg_user_registry_decrypt_error }}"

    - name: "Case 2: Both key and file missing - Add info warning"
      when: >-
        not backup_local_repo_credentials_key_stat.stat.exists and
        (backup_user_registry_content.stdout is not defined or
         '$ANSIBLE_VAULT;' not in backup_user_registry_content.stdout) and
        "'INFO: Both user_registry_credential.yml and .local_repo_credentials_key' not in (upgrade_warnings | join(' '))"
      ansible.builtin.set_fact:
        upgrade_warnings: >-
          {{ upgrade_warnings + [
            "INFO: Both user_registry_credential.yml and .local_repo_credentials_key " +
            "are not present in backup. This is expected if registry credentials " +
            "were not configured in the source installation."
          ] }}

    - name: "Case 3: Error - Mismatched state"
      when: >-
        (not backup_local_repo_credentials_key_stat.stat.exists and
         backup_user_registry_content.stdout is defined and
         '$ANSIBLE_VAULT;' in backup_user_registry_content.stdout) or
        (backup_local_repo_credentials_key_stat.stat.exists and
         backup_user_registry_content.stdout is defined and
         '$ANSIBLE_VAULT;' not in backup_user_registry_content.stdout)
      ansible.builtin.fail:
        msg: |
          ERROR: Inconsistent state detected for user_registry_credential.yml:
          {% if not backup_local_repo_credentials_key_stat.stat.exists and
             backup_user_registry_content.stdout is defined and
             '$ANSIBLE_VAULT;' in backup_user_registry_content.stdout %}
          - File is encrypted but key file (.local_repo_credentials_key) is missing
          {% elif backup_local_repo_credentials_key_stat.stat.exists and
             backup_user_registry_content.stdout is defined and
             '$ANSIBLE_VAULT;' not in backup_user_registry_content.stdout %}
          - Key file exists but file is not encrypted
          {% endif %}
          Please check the backup integrity and ensure both files are present
          in consistent states.
