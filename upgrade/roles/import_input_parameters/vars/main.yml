# Copyright 2026 Dell Inc. or its subsidiaries. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---

# backup_location will be set from oim_metadata.yml upgrade_backup_dir
# Format: /opt/omnia/backups/upgrade/version_2.0.0.0/input/project_default
# Set dynamically from metadata, no static variable needed

# Path to oim_metadata.yml
oim_metadata_path: "/opt/omnia/.data/oim_metadata.yml"

backup_dir_mode: '0755'
default_file_mode: '0644'

# List to collect warnings during execution
upgrade_warnings: []

# Precheck backup location messages
msg_backup_location_missing: "backup_location must be provided"
msg_upgrade_backup_dir_missing: "upgrade_backup_dir not found in /opt/omnia/.data/oim_metadata.yml"

# Restore input files messages
msg_restore_item_name_missing: "restore_item must define 'name'"
msg_validation_failed: "Validation failed for {{ restore_item.name }}"
msg_backup_file_missing: "Backup file missing: {{ restore_item.name }}"
msg_user_registry_credential_missing: |-
  WARNING: user_registry_credential.yml not found in backup at
  {{ backup_location }}/user_registry_credential.yml
  This might be due to complete Omnia execution not being completed.
  Skipping restoration of this file.

# Omnia config credentials messages
msg_omnia_config_credentials_missing: |-
  WARNING: omnia_config_credentials.yml not found in backup at
  {{ backup_location }}/omnia_config_credentials.yml.
  This might be due to complete Omnia execution not being completed.
  Skipping restoration of this file.

msg_omnia_config_credentials_info_missing: |-
  INFO: Both omnia_config_credentials.yml and .omnia_config_credentials_key
  are not present in backup. This is expected if credentials
  were not configured in the source installation.

msg_omnia_config_credentials_success: |-
  omnia_config_credentials.yml restored and updated from backup.
  Backup: {{ backup_location }}/omnia_config_credentials.yml
  Target: {{ input_project_dir }}/omnia_config_credentials.yml
  Status: Updated with postgres credentials and re-encrypted (key file also restored)

msg_omnia_config_credentials_error: |-
  ERROR: Inconsistent state detected for omnia_config_credentials.yml:
  {% if not backup_omnia_config_credentials_key_stat.stat.exists and
     backup_omnia_config_credentials_content.stdout is defined and
     '$ANSIBLE_VAULT;' in backup_omnia_config_credentials_content.stdout %}
  - File is encrypted but key file (.omnia_config_credentials_key) is missing
  {% elif backup_omnia_config_credentials_key_stat.stat.exists and
     backup_omnia_config_credentials_content.stdout is defined and
     '$ANSIBLE_VAULT;' not in backup_omnia_config_credentials_content.stdout %}
  - Key file exists but file is not encrypted
  {% endif %}
  Please check the backup integrity and ensure both files are present
  in consistent states.

# Rescue warning messages
msg_user_registry_decrypt_error: |-
  ERROR: Failed to decrypt user_registry_credential.yml.
  The backup key file may be corrupted or incompatible.
  Please check the backup integrity and ensure the key file
  matches the encrypted file.

msg_omnia_config_decrypt_error: |-
  ERROR: Failed to decrypt omnia_config_credentials.yml.
  The backup key file may be corrupted or incompatible.
  Please check the backup integrity and ensure the key file
  matches the encrypted file.

msg_omnia_config_template_error: |-
  ERROR: Failed to generate updated omnia_config_credentials.yml.
  Template processing may have failed due to invalid data format.
  Please check the backup file format and ensure it contains valid YAML.

msg_omnia_config_encrypt_error: |-
  ERROR: Failed to encrypt updated omnia_config_credentials.yml.
  The key file may be corrupted or there may be permission issues.
  Please check the key file integrity and file permissions.

msg_decryption_failed: "Decryption failed. Check warnings for details."
msg_template_failed: "Template processing failed. Check warnings for details."
msg_encryption_failed: "Encryption failed. Check warnings for details."

# Network spec transformation messages
msg_backup_network_spec_missing: "Backup network_spec.yml missing"
msg_network_spec_missing: "network_spec.yml missing"
msg_network_spec_already_21: "network_spec.yml already in 2.1 format - overwriting"
msg_yaml_validation_failed: "YAML validation failed"
msg_ib_netmask_mismatch: "ib_network.netmask_bits must match admin_network.netmask_bits"
msg_ib_network_missing: "ib_network is mandatory"
msg_ib_subnet_missing: "ib_network.subnet is mandatory"
msg_using_backup_network_spec: "Using backup network_spec.yml (backup not modified)"

# High availability config transformation messages
msg_backup_ha_config_missing: "Backup high_availability_config.yml missing"
msg_ha_config_missing: "high_availability_config.yml missing"
msg_ha_config_already_21: "high_availability_config.yml already in 2.1 format - overwriting"
msg_ha_virtual_ip_missing: "service_k8s_cluster_ha.virtual_ip_address is mandatory"
msg_using_backup_ha_config: "Using backup high_availability_config.yml (backup not modified)"

# Local repo config transformation messages
msg_backup_local_repo_config_missing: "Backup local_repo_config.yml missing"
msg_local_repo_config_missing: "local_repo_config.yml missing"
msg_using_backup_local_repo_config: "Using backup local_repo_config.yml (backup not modified)"
msg_omnia_repo_url_rhel_x86_64_missing: "omnia_repo_url_rhel_x86_64 is mandatory"
msg_omnia_repo_url_rhel_aarch64_missing: "omnia_repo_url_rhel_aarch64 is mandatory"

# Provision config transformation messages
msg_backup_provision_config_missing: "Backup provision_config.yml missing"
msg_provision_config_missing: "provision_config.yml missing"
msg_using_backup_provision_config: "Using backup provision_config.yml (backup not modified)"
msg_pxe_mapping_file_path_missing: "pxe_mapping_file_path is mandatory"

# Storage config transformation messages
msg_backup_storage_config_missing: "storage_config.yml not found in backup at {{ backup_location }}/storage_config.yml"
msg_storage_config_missing: "storage_config.yml not found at {{ input_project_dir }}/storage_config.yml"
msg_nfs_client_params_missing: "storage_config.yml must define nfs_client_params with at least one entry"
msg_nfs_client_param_entry_missing_keys: "Each nfs_client_params entry must define server_ip, server_share_path, and client_share_path"
msg_using_backup_storage_config: "Transforming storage_config.yml from backup at {{ backup_location }}/storage_config.yml"

# Omnia config transformation messages
msg_backup_omnia_config_missing: "Backup omnia_config.yml missing"
msg_omnia_config_missing: "omnia_config.yml missing"
msg_using_backup_omnia_config: "Using backup omnia_config.yml (backup not modified)"
msg_slurm_cluster_missing: "slurm_cluster is mandatory"
msg_service_k8s_cluster_missing: "service_k8s_cluster is mandatory"

# Telemetry config transformation messages
msg_backup_telemetry_config_missing: "Backup telemetry_config.yml missing"
msg_telemetry_config_missing: "telemetry_config.yml missing"
msg_using_backup_telemetry_config: "Using backup telemetry_config.yml (backup not modified)"

### Restore summary messages
msg_restore_summary: |
  {{ restore_item.name }} restored from backup.
  Backup: {{ backup_location }}/{{ restore_item.name }}
  Target: {{ input_project_dir }}/{{ restore_item.name }}

# Restore summary message for network spec transformation
msg_network_spec_transform_summary: |
  network_spec.yml upgraded to 2.1 format.
  Backup preserved at: {{ backup_location }}/network_spec.yml
  Changes:
  - Added mandatory ib_network
  - Made primary_oim_bmc_ip optional
  - Aligned ib_network.netmask_bits with admin_network.netmask_bits

# Restore summary message for high availability config transformation
msg_ha_config_transform_summary: |
  high_availability_config.yml upgraded to 2.1 format.
  Backup preserved at: {{ backup_location }}/high_availability_config.yml
  Changes:
  - Ensured service_k8s_cluster_ha is a list
  - Ensured virtual_ip_address is present

# Restore summary message for local repo config transformation
msg_local_repo_config_transform_summary: |
  local_repo_config.yml upgraded to 2.1 format.
  Backup preserved at: {{ backup_location }}/local_repo_config.yml
  Changes:
  - Normalized repo URL keys to arch-specific schema
  - Migrated omnia_registry to user_registry (when present)
  - Ensured mandatory omnia_repo_url_rhel_* keys are present

# Restore summary message for provision config transformation
msg_provision_config_transform_summary: |
  provision_config.yml upgraded to 2.1 format.
  Backup preserved at: {{ backup_location }}/provision_config.yml
  Changes:
  - Ensured pxe_mapping_file_path, language, and default_lease_time are present

# Restore summary message for storage config transformation
msg_storage_config_transform_summary: |
  storage_config.yml upgraded to 2.1 format.
  Backup preserved at: {{ backup_location }}/storage_config.yml
  Changes:
  - Ensured nfs_client_params is present and entries contain required keys

# Restore summary message for omnia config transformation
msg_omnia_config_transform_summary: |
  omnia_config.yml upgraded to 2.1 format.
  Backup preserved at: {{ backup_location }}/omnia_config.yml
  Changes:
  - Ensured slurm_cluster and service_k8s_cluster are lists
  - Ensured required sections are present

# Restore summary message for telemetry config transformation
msg_telemetry_config_transform_summary: |
  telemetry_config.yml upgraded to 2.1 format.
  Backup preserved at: {{ backup_location }}/telemetry_config.yml
  Changes:
  - Rendered Omnia 2.1 telemetry template with values from 2.0 backup
  - Applied schema defaults for missing fields

# === Input files to restore from backup ===
# Add input files here that should be copied from backup_location to input_project_dir
# Each entry should have:
# - name: filename (required)
# - mode: file permissions (optional, defaults to default_file_mode)
# - validate_cmd: validation command (optional, runs after restore)
#
# Examples of files to add:
# - Static configuration files that don't need transformation
# - Files that are the same format in 2.0 and 2.1
# - Files where you want to preserve the backup values exactly
#
# DO NOT add files that require transformation (network_spec.yml, high_availability_config.yml, local_repo_config.yml,
# provision_config.yml, user_registry_credential.yml)
restore_input_files:
  - name: software_config.json
    mode: '0644'
    validate_cmd: "python3 -m json.tool '{{ input_project_dir }}/software_config.json'"
  - name: security_config.yml
    mode: '0644'
    validate_cmd: "python3 -c \"import yaml; yaml.safe_load(open('{{ input_project_dir }}/security_config.yml','r'))\""
  - name: pxe_mapping_file.csv
    mode: '0644'
    validate_cmd: ""
